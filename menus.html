<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - ‡∏î‡∏≠‡∏¢‡∏™‡∏∞‡πÇ‡∏á‡πâ‡∏ß‡∏¥‡∏ß‡πÇ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏¢‡πå</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2d6a4f;
            --secondary: #52b788;
            --accent: #d8f3dc;
            --dark: #1b4332;
            --light: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --danger: #e63946;
            --gray: #adb5bd;
        }
        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { background-color: var(--light); color: var(--dark); margin: 0; padding-bottom: 100px; }
        header { background: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        
        .shop-status { font-size: 0.85rem; padding: 4px 12px; border-radius: 12px; font-weight: 500; margin-top: 5px; display: inline-block; }
        .status-open { background: var(--accent); color: var(--primary); }
        .status-closed { background: #ffe3e3; color: var(--danger); }

        .category-scroll { display: flex; overflow-x: auto; padding: 10px 20px; gap: 10px; background: var(--white); white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .category-btn { padding: 8px 16px; border-radius: 20px; border: none; background: var(--accent); color: var(--primary); font-weight: 500; cursor: pointer; transition: 0.2s; }
        .category-btn.active { background: var(--primary); color: var(--white); }
        
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 20px; }
        .menu-card { background: var(--white); border-radius: 15px; overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; height: 100%; transition: opacity 0.3s; }
        .menu-card.disabled { opacity: 0.6; }
        .menu-img { width: 100%; height: 120px; object-fit: cover; background: #eee; }
        .menu-info { padding: 12px; flex-grow: 1; }
        .menu-name { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; }
        .menu-price { color: var(--primary); font-weight: 600; font-size: 1.1rem; }
        
        .add-btn { width: 100%; padding: 10px; border: none; background: var(--primary); color: white; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .add-btn:disabled { background: var(--gray); cursor: not-allowed; }
        .add-btn:active:not(:disabled) { opacity: 0.8; }
        
        #cart-modal { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transform: translateY(100%); transition: transform 0.3s ease-out; z-index: 1000; max-height: 80vh; overflow-y: auto; }
        #cart-modal.open { transform: translateY(0); }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .qty-controls { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--primary); background: white; display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; color: var(--primary); }
        
        .order-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--primary); color: white; padding: 15px 25px; border-radius: 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 25px rgba(45, 106, 79, 0.3); cursor: pointer; z-index: 999; }
        .msg-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 12px; z-index: 2000; display: none; text-align: center; min-width: 200px; }
        textarea, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-top: 10px; font-size: 1rem; }
        select.error { border-color: var(--danger); background-color: #fff5f5; }
    </style>
</head>
<body>

    <header>
        <div>
            <div style="font-weight: 600; font-size: 1.1rem;">‚õ∞Ô∏è ‡πÇ‡∏ï‡πä‡∏∞: <span id="display-table">-</span></div>
            <div id="shop-time-status" class="shop-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
        <div id="status-dot" title="‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;"></div>
    </header>

    <div class="category-scroll" id="category-list">
        <button class="category-btn active" onclick="filterMenu('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div class="menu-grid" id="menu-container"></div>

    <div class="order-bar" id="order-bar" style="display: none;" onclick="toggleCart()">
        <span id="cart-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        <span style="font-weight: 600;">‡∏î‡∏π‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ üõí</span>
        <span id="cart-total">‡∏ø0</span>
    </div>

    <div id="cart-modal">
        <h3 style="margin-top: 0; display: flex; justify-content: space-between;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ <span onclick="toggleCart()" style="cursor:pointer; color: #999;">‚úï</span></h3>
        <div id="cart-items-list"></div>
        <div style="margin-top: 20px;">
            <label style="font-weight: 600;">‚è∞ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü <span style="color:var(--danger)">*</span>:</label>
            <select id="serving-time">
                <option value="" selected disabled>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü --</option>
            </select>
            <label style="font-weight: 600; display: block; margin-top: 15px;">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
            <textarea id="global-note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î, ‡πÅ‡∏û‡πâ‡∏Å‡∏∏‡πâ‡∏á..."></textarea>
        </div>
        <button id="submit-order-btn" onclick="sendOrder()" style="width:100%; background: var(--primary); color:white; border:none; padding:15px; border-radius:12px; font-size:1.1rem; font-weight:600; margin-top:20px; cursor:pointer;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
    </div>

    <div class="msg-box" id="msg-box"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const tname = urlParams.get('tname') || "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏";
        document.getElementById('display-table').innerText = tname;

        let menuData = [];
        let cart = [];
        let telegramConfig = { token: "", chatID: "" };
        let isShopOpen = true;

        async function init() {
            try {
                const response = await fetch('data.json');
                const data = await response.json();
                menuData = data.menus;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô
                checkShopTime(data.Ttime);

                if(data.telegram && data.telegram.length > 0) {
                    telegramConfig = data.telegram[0];
                }

                const timeSelect = document.getElementById('serving-time');
                if(data.Ttimeservice) {
                    data.Ttimeservice.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t;
                        opt.innerText = t;
                        timeSelect.appendChild(opt);
                    });
                }

                const categories = [...new Set(menuData.map(m => m.Mtype))];
                renderCategories(categories);
                renderMenu(menuData);
                document.getElementById('status-dot').style.background = '#27ae60';
            } catch (e) {
                console.error("Load fail", e);
                showMsg("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
            }
        }

        function checkShopTime(timeConfig) {
            if (!timeConfig || timeConfig.length === 0) return;
            
            const config = timeConfig[0];
            const now = new Date();
            const currentTimeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "13:00‡∏ô." ‡πÄ‡∏õ‡πá‡∏ô "13:00"
            const openTime = config.timeopen.replace('‡∏ô.', '');
            const closeTime = config.timeclose.replace('‡∏ô.', '');
            
            const statusEl = document.getElementById('shop-time-status');
            
            if (currentTimeStr >= openTime && currentTimeStr <= closeTime) {
                isShopOpen = true;
                statusEl.innerText = `üü¢ ‡πÄ‡∏õ‡∏¥‡∏î (‡∏õ‡∏¥‡∏î ${config.timeclose})`;
                statusEl.className = "shop-status status-open";
            } else {
                isShopOpen = false;
                statusEl.innerText = `üî¥ ‡∏Ñ‡∏£‡∏±‡∏ß‡∏õ‡∏¥‡∏î (‡πÄ‡∏õ‡∏¥‡∏î ${config.timeopen})`;
                statusEl.className = "shop-status status-closed";
            }
        }

        function renderCategories(categories) {
            const list = document.getElementById('category-list');
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerText = cat;
                btn.onclick = () => filterMenu(cat, btn);
                list.appendChild(btn);
            });
        }

        function renderMenu(items) {
            const container = document.getElementById('menu-container');
            container.innerHTML = '';
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = `menu-card ${!isShopOpen ? 'disabled' : ''}`;
                const imgSrc = item.Mimg ? `img/${item.Mimg}` : `https://placehold.co/400x300?text=${encodeURIComponent(item.Mid)}`;
                
                card.innerHTML = `
                    <img src="${imgSrc}" class="menu-img" alt="${item.Mid}" onerror="this.src='https://placehold.co/400x300?text=${encodeURIComponent(item.Mid)}'">
                    <div class="menu-info">
                        <div class="menu-name">${item.Mid}</div>
                        <div class="menu-price">‡∏ø${item.Mprice}</div>
                        ${item.Mnote ? `<small style="color:#666; display:block; margin-top:4px;">(${item.Mnote})</small>` : ''}
                    </div>
                    <button class="add-btn" 
                            onclick="addToCart('${item.Mid}', ${item.Mprice})" 
                            ${!isShopOpen ? 'disabled' : ''}>
                        ${isShopOpen ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤' : '‡∏Ñ‡∏£‡∏±‡∏ß‡∏õ‡∏¥‡∏î'}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function filterMenu(type, btn) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(type === 'all') renderMenu(menuData);
            else renderMenu(menuData.filter(m => m.Mtype === type));
        }

        function addToCart(name, price) {
            if(!isShopOpen) return;
            const existing = cart.find(i => i.name === name);
            if(existing) existing.qty++;
            else cart.push({ name, price, qty: 1 });
            updateCartUI();
            showMsg(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${name} ‡πÅ‡∏•‡πâ‡∏ß`);
        }

        function updateCartUI() {
            const totalQty = cart.reduce((sum, i) => sum + i.qty, 0);
            const totalAmt = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            document.getElementById('cart-count').innerText = `${totalQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            document.getElementById('cart-total').innerText = `‡∏ø${totalAmt.toLocaleString()}`;
            document.getElementById('order-bar').style.display = totalQty > 0 ? 'flex' : 'none';
            renderCartItems();
        }

        function renderCartItems() {
            const list = document.getElementById('cart-items-list');
            if(cart.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#999; padding: 20px 0;">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
                return;
            }
            list.innerHTML = '';
            cart.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:500">${item.name}</div>
                        <small style="color:var(--primary)">‡∏ø${(item.price * item.qty).toLocaleString()}</small>
                    </div>
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="changeQty(${index}, -1)">-</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn" onclick="changeQty(${index}, 1)">+</button>
                    </div>`;
                list.appendChild(div);
            });
        }

        function changeQty(index, delta) {
            cart[index].qty += delta;
            if(cart[index].qty <= 0) cart.splice(index, 1);
            updateCartUI();
        }

        function toggleCart() { 
            const modal = document.getElementById('cart-modal');
            modal.classList.toggle('open'); 
        }

        function showMsg(text) { 
            const box = document.getElementById('msg-box'); 
            box.innerText = text; 
            box.style.display = 'block'; 
            setTimeout(() => { box.style.display = 'none'; }, 2000); 
        }

        async function sendOrder() {
            if(!isShopOpen) {
                showMsg("‚ö†Ô∏è ‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ß‡∏õ‡∏¥‡∏î‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß");
                return;
            }

            const timeSelect = document.getElementById('serving-time');
            if(!timeSelect.value) {
                timeSelect.classList.add('error');
                showMsg("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
                timeSelect.focus();
                return;
            }
            timeSelect.classList.remove('error');

            if(!telegramConfig.token || !telegramConfig.chatID) {
                showMsg("‚ùå ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Telegram ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
                return;
            }

            const btn = document.getElementById('submit-order-btn');
            const globalNote = document.getElementById('global-note').value;
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            const orderId = Math.random().toString(36).substr(2, 6).toUpperCase();

            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...";

            const itemText = cart.map(i => `‚Ä¢ ${i.name} x${i.qty}`).join('\n');
            const message = `üõé <b>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà! [#${orderId}]</b>\nüìç ‡πÇ‡∏ï‡πä‡∏∞: <b>${tname}</b>\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü: ${timeSelect.value}\n------------------\n${itemText}\n------------------\nüìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${globalNote || '-'}\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <b>‡∏ø${total.toLocaleString()}</b>`;

            try {
                const res = await fetch(`https://api.telegram.org/bot${telegramConfig.token}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: telegramConfig.chatID, text: message, parse_mode: 'HTML' })
                });

                if(res.ok) {
                    const savedOrders = JSON.parse(localStorage.getItem('my_orders') || '[]');
                    savedOrders.push({ 
                        orderId, tname, items: [...cart], total, 
                        timestamp: new Date().toLocaleTimeString('th-TH'), 
                        selectedTime: timeSelect.value, globalNote 
                    });
                    localStorage.setItem('my_orders', JSON.stringify(savedOrders));
                    
                    showMsg("‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    setTimeout(() => { 
                        window.location.href = `orders.html?tname=${encodeURIComponent(tname)}`; 
                    }, 1500);
                } else { 
                    throw new Error("Telegram API Error"); 
                }
            } catch (e) {
                showMsg("‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏à‡πâ‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
                btn.disabled = false;
                btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
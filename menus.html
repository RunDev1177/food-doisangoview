<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เมนูอาหาร - ดอยสะโง้วิว</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f9fafb; }
        .primary-bg { background-color: #1B6E3F; }
        .primary-text { color: #1B6E3F; }
        .time-chip { border: 1px solid #e5e7eb; transition: all 0.2s; cursor: pointer; background-color: white; }
        .time-chip.selected { background-color: #1B6E3F; color: white; border-color: #1B6E3F; }
        .category-btn { transition: all 0.2s; white-space: nowrap; }
        .category-btn.active { background-color: #1B6E3F; color: white; border-color: #1B6E3F; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="pb-32">
    <nav class="primary-bg text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-3">
                
                <div class="flex items-baseline gap-2">
                    <span class="text-xl font-medium opacity-90">เมนูอาหาร</span>
                    <span id="display-table" class="font-bold text-2xl">โต๊ะ -</span>
                </div>
            </div>
            
            <div class="relative cursor-pointer flex items-center gap-1" onclick="toggleCartModal()">
    <div class="relative">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] rounded-full px-1.5 py-0.5 hidden font-bold">0</span>
    </div>
</div>

        </div>
        <div id="category-bar" class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
            <button onclick="filterCategory('ทั้งหมด')" class="category-btn active px-4 py-1.5 rounded-full border border-white/30 text-sm font-medium">ทั้งหมด</button>
        </div>
    </nav>

    <main id="menu-container" class="p-4 space-y-4">
        <div class="text-center py-10 text-gray-400">กำลังเรียกรายการอาหาร...</div>
    </main>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-end justify-center">
        <div class="bg-white w-full max-w-lg rounded-t-3xl p-6 max-h-[95vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800">รายการที่เลือก</h2>
                <button onclick="toggleCartModal()" class="text-gray-400 text-3xl">&times;</button>
            </div>
            
            <div id="cart-items" class="space-y-6 mb-6"></div>

            <!-- ส่วนหมายเหตุรวม -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">หมายเหตุถึงร้านค้า (รวม)</label>
                <textarea id="overall-note" placeholder="เช่น ขอจานเพิ่ม, ไม่กินผัก..." class="w-full border rounded-xl p-3 text-sm focus:ring-2 focus:ring-[#1B6E3F] focus:outline-none bg-gray-50"></textarea>
            </div>

            <div class="mb-6 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 text-lg">เวลาเสริฟ</h3>
                <div id="time-slots" class="grid grid-cols-3 gap-2"></div>
                <p id="time-error" class="text-red-500 text-xs mt-2 hidden">⚠️ กรุณาเลือกเวลาก่อนสั่งอาหาร</p>
            </div>

            <div class="border-t pt-4">
                <div class="flex justify-between text-xl font-bold mb-6 primary-text">
                    <span>รวมทั้งสิ้น</span>
                    <span id="cart-total">0.00 ฿</span>
                </div>
                <button onclick="submitOrder()" class="w-full primary-bg text-white py-4 rounded-xl text-lg font-bold shadow-lg active:scale-95 transition-transform">ยืนยันสั่งอาหาร</button>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const tname = params.get('tname');
        let cart = [];
        let menuData = [];
        let currentCategory = 'ทั้งหมด';
        let scriptUrl = "";
        let selectedTimeValue = "";

        document.getElementById('display-table').innerText = `โต๊ะ ${tname || '-'}`;

        async function init() {
            try {
                const configResp = await fetch('data.json');
                const config = await configResp.json();
                scriptUrl = config.googlescript[0].url;
                
                const timeSlots = config.timeservice[0].slots;
                const timeContainer = document.getElementById('time-slots');
                timeSlots.forEach(time => {
                    const div = document.createElement('div');
                    div.className = "time-chip p-2 rounded-lg text-center text-sm font-medium border";
                    div.innerText = time;
                    div.onclick = () => {
                        selectedTimeValue = time;
                        document.querySelectorAll('.time-chip').forEach(c => c.classList.remove('selected'));
                        div.classList.add('selected');
                        document.getElementById('time-error').classList.add('hidden');
                    };
                    timeContainer.appendChild(div);
                });

                fetchMenus();
            } catch (e) { console.error(e); }
        }

        async function fetchMenus() {
            try {
                const response = await fetch(`${scriptUrl}?action=getMenus`);
                const data = await response.json();
                
                menuData = data.slice(1).filter(d => d[2] === "พร้อม").map(d => ({
                    name: d[0], 
                    price: parseFloat(d[1]), 
                    category: d[3] || "ทั่วไป", 
                    image: d[4],
                    note: d[5] || ""
                }));

                renderCategories();
                renderMenus();
            } catch (e) { document.getElementById('menu-container').innerHTML = "โหลดข้อมูลไม่สำเร็จ"; }
        }

        function renderCategories() {
            const categories = ['ทั้งหมด', ...new Set(menuData.map(item => item.category))];
            const container = document.getElementById('category-bar');
            container.innerHTML = '';
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `category-btn px-4 py-1.5 rounded-full border text-sm font-medium ${cat === currentCategory ? 'active' : 'border-white/30 text-white'}`;
                btn.innerText = cat;
                btn.onclick = () => filterCategory(cat);
                container.appendChild(btn);
            });
        }

        function filterCategory(cat) {
            currentCategory = cat;
            renderCategories();
            renderMenus();
        }

        function renderMenus() {
            const container = document.getElementById('menu-container');
            container.innerHTML = '';
            const filteredData = currentCategory === 'ทั้งหมด' ? menuData : menuData.filter(item => item.category === currentCategory);

            filteredData.forEach((item) => {
                const originalIndex = menuData.findIndex(m => m.name === item.name);
                const div = document.createElement('div');
                div.className = "bg-white rounded-xl shadow-sm flex p-3 gap-4 border border-gray-100 items-center";
                div.innerHTML = `
                    <div class="w-24 h-24 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                        <img src="img/${item.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200x200?text=Food'">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-gray-800 truncate">${item.name}</h3>
                        ${item.note ? `<p class="text-[11px] text-red-500 italic mb-1">*${item.note}</p>` : ''}
                        <p class="primary-text font-bold text-lg">${item.price.toLocaleString()} ฿</p>
                    </div>
                    <button onclick="addToCart(${originalIndex})" class="primary-bg text-white w-10 h-10 rounded-lg font-bold text-xl flex-shrink-0">+</button>
                `;
                container.appendChild(div);
            });
        }

        function addToCart(index) {
            const item = menuData[index];
            const found = cart.find(c => c.name === item.name);
            if(found) found.qty++;
            else cart.push({...item, qty: 1, itemNote: ""});
            updateCartUI();
        }

        function updateCartUI() {
            const count = cart.reduce((a, b) => a + b.qty, 0);
            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-count').classList.toggle('hidden', count === 0);
            
            const itemsContainer = document.getElementById('cart-items');
            itemsContainer.innerHTML = cart.map((item, i) => `
                <div class="border-b border-gray-100 pb-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex-1">
                            <div class="font-bold text-gray-700">${item.name} <span class="text-xs text-gray-400">(x${item.qty})</span></div>
                            <div class="primary-text text-sm font-bold">${(item.price * item.qty).toLocaleString()} ฿</div>
                        </div>
                        <button onclick="cart.splice(${i},1);updateCartUI()" class="text-red-400">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    <input type="text" placeholder="ระบุเพิ่มเติม เช่น เผ็ดน้อย..." 
                           oninput="cart[${i}].itemNote = this.value" 
                           value="${item.itemNote}"
                           class="w-full text-xs border rounded-lg p-2 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-green-600">
                </div>
            `).join('');
            
            const total = cart.reduce((a, b) => a + (b.price * b.qty), 0);
            document.getElementById('cart-total').innerText = `${total.toLocaleString()} ฿`;
        }

        function toggleCartModal() { document.getElementById('cart-modal').classList.toggle('hidden'); }

        async function submitOrder() {
            if(cart.length === 0) return;
            if(!selectedTimeValue) {
                document.getElementById('time-error').classList.remove('hidden');
                return;
            }

            const now = new Date();
            const dateStr = (now.getFullYear() + 543) + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
            let count = localStorage.getItem('order_count') || "0";
            count = String(parseInt(count) + 1).padStart(3, '0');
            localStorage.setItem('order_count', parseInt(count));
            
            const overallNote = document.getElementById('overall-note').value.trim();
            
            // ปรับปรุงรูปแบบการบันทึกรายการ: รายการอาหาร (xจำนวน) [หมายเหตุรายรายการ]
            const formattedItems = cart.map(i => {
                let text = `${i.name} (x${i.qty})`;
                if(i.itemNote) text += ` [${i.itemNote}]`;
                return text;
            }).join(', ');

            // รวมรายการทั้งหมด และ หมายเหตุรวมของออเดอร์
            const finalOrderText = overallNote ? `${formattedItems}, หมายเหตุ: ${overallNote}` : formattedItems;

            const orderData = {
                orderId: dateStr + count,
                items: finalOrderText,
                total: cart.reduce((a, b) => a + (b.price * b.qty), 0).toFixed(2),
                table: tname || '-',
                status: 'รอ',
                serveTime: selectedTimeValue
            };

            localStorage.setItem('pending_order', JSON.stringify(orderData));
            window.location.href = `sendtelegram.html?tname=${encodeURIComponent(tname || '')}`;
        }

        init();
    </script>
</body>
</html>
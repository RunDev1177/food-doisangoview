<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á - ‡∏î‡∏≠‡∏¢‡∏™‡∏∞‡πÇ‡∏á‡πâ‡∏ß‡∏¥‡∏ß</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #1B6E3F;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .social-btn { transition: all 0.2s; }
        .social-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-[#1B6E3F] text-white p-4 sticky top-0 flex justify-between items-center shadow-lg z-50">
        <span class="font-bold text-lg">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
        <!-- ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô -->
        <button onclick="requestCheckOut()" class="bg-yellow-400 text-[#1B6E3F] px-6 py-2 rounded-xl text-sm font-extrabold active:scale-90 transition-all shadow-[0_4px_0_rgb(202,138,4)] active:shadow-none active:translate-y-1">
            ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
        </button>
    </nav>

    <main class="p-6 max-w-lg mx-auto">
        <div class="bg-white rounded-3xl p-6 shadow-sm border-t-8 border-[#1B6E3F]">
            <div class="text-center mb-8">
                <div class="bg-green-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-[#1B6E3F]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800" id="order-table">‡πÇ‡∏ï‡πä‡∏∞ -</h2>
                <div class="flex items-center justify-center gap-2 mt-1">
                    <span class="inline-block w-2 h-2 bg-orange-500 rounded-full status-pulse"></span>
                    <p class="text-gray-400 text-sm">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</p>
                </div>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î -->
            <div id="loading-state" class="flex flex-col items-center py-10">
                <div class="loader mb-3"></div>
                <p class="text-gray-400 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ß...</p>
            </div>

            <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ -->
            <div id="order-list" class="space-y-4 hidden">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏£‡∏≠" ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>

            <!-- ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
            <div id="empty-state" class="hidden text-center py-12">
                <div class="text-gray-300 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0a2 2 0 01-2 2H6a2 2 0 01-2-2m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                </div>
                <p class="text-gray-400 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
            </div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° -->
            <div class="mt-10 space-y-3">
                <button onclick="goBackToMenu()" class="w-full bg-[#1B6E3F] text-white py-4 rounded-2xl font-bold text-lg shadow-md active:scale-95 transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°
                </button>
                <button onclick="fetchOrders()" class="w-full text-[#1B6E3F] py-2 text-sm font-medium">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡∏ß‡∏¥‡∏ß -->
            <div class="mt-8 pt-6 border-t border-dashed flex flex-col gap-3">
                <p class="text-center text-xs text-gray-400 mb-1">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏ä‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                <div class="grid grid-cols-2 gap-3">
                    <a href="https://www.facebook.com/sangoviewhomestay/" target="_blank" class="social-btn flex items-center justify-center gap-2 py-3 bg-[#1877F2] text-white rounded-xl text-xs font-bold shadow-sm">
                        <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        Facebook
                    </a>
                    <a href="https://maps.app.goo.gl/wqqiNg2JcdU9B1q59" target="_blank" class="social-btn flex items-center justify-center gap-2 py-3 bg-white border border-gray-200 text-gray-700 rounded-xl text-xs font-bold shadow-sm">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô
                    </a>
                </div>
                <p class="text-[10px] text-center text-gray-400 uppercase tracking-widest mt-4 italic">Doi Sa-Ngo View Homestay</p>
            </div>
        </div>
    </main>

    <!-- Modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô -->
    <div id="checkout-modal" class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-6 hidden">
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm text-center">
            <div class="text-5xl mb-4">üí∞</div>
            <h3 class="text-xl font-bold mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
            <p class="text-gray-500 mb-6 text-sm">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex gap-3">
                <button onclick="toggleCheckoutModal()" class="flex-1 py-3 border rounded-xl font-bold text-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmCheckout()" class="flex-1 py-3 bg-[#1B6E3F] text-white rounded-xl font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const tname = params.get('tname');
        let scriptUrl = "";

        function goBackToMenu() {
            window.location.href = `menus.html?tname=${encodeURIComponent(tname || '')}`;
        }

        function toggleCheckoutModal() {
            document.getElementById('checkout-modal').classList.toggle('hidden');
        }

        function requestCheckOut() {
            toggleCheckoutModal();
        }

        async function confirmCheckout() {
            toggleCheckoutModal();
            try {
                const configResp = await fetch('data.json');
                const config = await configResp.json();
                const botToken = config.telegram[0].token;
                const chatID = config.telegram[0].chatID;

                const message = `üîî *[‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô]*\n‡πÇ‡∏ï‡πä‡∏∞: ${tname || '-'}\n‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠: ${new Date().toLocaleTimeString('th-TH')}`;
                
                await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });

                showStatus("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...");
            } catch (e) {
                console.error(e);
                showStatus("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á");
            }
        }

        function showStatus(msg) {
            const statusDiv = document.createElement('div');
            statusDiv.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-sm shadow-2xl z-[200]";
            statusDiv.innerText = msg;
            document.body.appendChild(statusDiv);
            setTimeout(() => statusDiv.remove(), 3000);
        }

        async function fetchOrders() {
            const list = document.getElementById('order-list');
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');

            loading.classList.remove('hidden');
            list.classList.add('hidden');
            empty.classList.add('hidden');

            try {
                const configResp = await fetch('data.json');
                const config = await configResp.json();
                scriptUrl = config.googlescript[0].url;

                document.getElementById('order-table').innerText = `‡πÇ‡∏ï‡πä‡∏∞ ${tname || '-'}`;

                const response = await fetch(`${scriptUrl}?action=getOrders`);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();

                const waitingOrders = data.slice(1).filter(row => {
                    const rowTable = String(row[4]).trim();
                    const rowStatus = String(row[5]).trim();
                    return rowTable === tname && rowStatus === "‡∏£‡∏≠";
                });

                renderOrders(waitingOrders);
            } catch (e) {
                console.error("Error:", e);
                renderFallback();
            }
        }

        function renderOrders(orders) {
            const list = document.getElementById('order-list');
            const loading = document.getElementById('loading-state');
            const empty = document.getElementById('empty-state');

            loading.classList.add('hidden');
            
            if (orders.length === 0) {
                empty.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            list.innerHTML = "";

            orders.forEach(order => {
                const itemsStr = order[2];
                const totalAmount = order[3];
                const serveTime = order[6];
                const orderId = order[1];
                
                const card = document.createElement('div');
                card.className = "bg-orange-50/70 p-5 rounded-2xl border border-orange-100 relative shadow-sm";
                
                const itemsParts = itemsStr.split(', ');
                const itemsHtml = itemsParts.map(part => {
                    if (part.startsWith('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:')) {
                        return `<div class="mt-2 pt-2 border-t border-orange-100 text-orange-700 italic text-[12px]">${part}</div>`;
                    }
                    return `<div class="font-medium">${part}</div>`;
                }).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <span class="px-3 py-1 bg-orange-500 text-white text-[10px] rounded-full font-bold shadow-sm uppercase tracking-wider">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</span>
                            <span class="text-[10px] text-gray-400 font-medium">#${orderId}</span>
                        </div>
                        ${serveTime ? `<span class="text-[10px] text-[#1B6E3F] font-bold">‡∏£‡∏≠‡∏ö: ${serveTime}</span>` : ''}
                    </div>
                    <div class="text-gray-700 text-sm leading-relaxed mb-3">
                        ${itemsHtml}
                    </div>
                    <div class="flex justify-between items-center border-t border-orange-100 pt-3">
                        <span class="text-[11px] text-gray-400 italic">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ:</span>
                        <span class="text-lg font-bold text-[#1B6E3F]">${parseFloat(totalAmount).toLocaleString()} ‡∏ø</span>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function renderFallback() {
            const loading = document.getElementById('loading-state');
            const list = document.getElementById('order-list');
            loading.classList.add('hidden');
            
            const lastOrder = JSON.parse(localStorage.getItem('pending_order'));
            if (lastOrder && lastOrder.table === tname) {
                list.classList.remove('hidden');
                list.innerHTML = `
                    <div class="bg-gray-100 p-5 rounded-2xl border border-gray-200 opacity-70">
                        <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á text-red-500 -->
                        <p class="text-[18px] text-red-500 mb-2 font-bold uppercase tracking-wider italic">**‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...)</p>
                        <p class="text-gray-700 text-sm mb-2">${lastOrder.items.split(', ').join('<br>')}</p>
                        <div class="text-right font-bold text-gray-600">${parseFloat(lastOrder.total).toLocaleString()} ‡∏ø</div>
                    </div>
                `;
            } else {
                document.getElementById('empty-state').classList.remove('hidden');
            }
        }

        window.onload = fetchOrders;
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå - ‡πÇ‡∏ï‡πä‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2d6a4f; --dark: #1b4332; --light: #f8f9fa; --white: #ffffff; --warning: #f4a261; }
        * { box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { background: var(--light); margin: 0; padding: 20px; padding-bottom: 100px; }
        header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; background: var(--white); padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .table-info { background: var(--primary); color: var(--white); padding: 8px 20px; border-radius: 10px; text-align: center; font-weight: 600; }
        .order-card { background: var(--white); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        .order-head { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px; }
        .order-id { font-weight: 600; color: var(--primary); }
        .item-row { display: flex; justify-content: space-between; font-size: 0.95rem; margin-bottom: 5px; }
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); padding: 15px 20px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .btn-call { flex: 1; background: var(--warning); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .btn-back { flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; text-align: center; text-decoration: none; }
        .msg-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 10px 20px; border-radius: 10px; z-index: 2000; display: none; width: 80%; text-align: center; }
    </style>
</head>
<body>
    <div id="msg" class="msg-box"></div>
    <header>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size: 1.2rem; font-weight: 600;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
            <div id="current-time" style="font-size:0.85rem; color:#888;"></div>
        </div>
        <div class="table-info" id="table-display">‡πÇ‡∏ï‡πä‡∏∞: -</div>
    </header>
    <div id="orders-container"></div>
    <div class="nav-bottom">
        <a href="#" id="back-to-menu" class="btn-back">‚ûï ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</a>
        <button class="btn-call" onclick="callStaff()">üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const tname = params.get('tname') || "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏";
        document.getElementById('table-display').innerText = `‡πÇ‡∏ï‡πä‡∏∞: ${tname}`;
        document.getElementById('back-to-menu').href = `menus.html?tname=${encodeURIComponent(tname)}`;

        let telegramConfig = { token: "", chatID: "" };

        async function loadConfig() {
            try {
                const res = await fetch('data.json');
                const data = await res.json();
                if (data.telegram && data.telegram[0]) telegramConfig = data.telegram[0];
            } catch (e) { console.error(e); }
        }

        function showMsg(text) {
            const m = document.getElementById('msg');
            m.innerText = text; m.style.display = 'block';
            setTimeout(() => m.style.display = 'none', 3000);
        }

        function renderOrders() {
            const container = document.getElementById('orders-container');
            const allOrders = JSON.parse(localStorage.getItem('my_orders') || '[]');
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const filteredOrders = allOrders.filter(order => order.tname === tname);

            if (filteredOrders.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:50px; color:#888;">üì¶<br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ</div>`;
                return;
            }

            container.innerHTML = filteredOrders.reverse().map(order => `
                <div class="order-card">
                    <div class="order-head"><span class="order-id">#${order.orderId}</span><span style="font-size:0.8rem; color:#888;">${order.timestamp}</span></div>
                    <div class="order-body">${order.items.map(i => `<div class="item-row"><span>${i.qty}x ${i.name}</span><span>‡∏ø${(i.price * i.qty).toLocaleString()}</span></div>`).join('')}</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 8px; border-top:1px dashed #eee; padding-top:5px;">
                        üïí ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü: ${order.selectedTime || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | üí∞ ‡∏£‡∏ß‡∏°: ‡∏ø${order.total.toLocaleString()}<br>
                        ${order.globalNote ? `üìù: ${order.globalNote}` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function callStaff() {
            if (!telegramConfig.token || !telegramConfig.chatID) {
                showMsg("‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°"); return;
            }
            const btn = document.querySelector('.btn-call');
            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å...";
            const message = `üîî <b>[‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô]</b>\nüìç ‡πÇ‡∏ï‡πä‡∏∞: <b>${tname}</b>\n‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleTimeString('th-TH')}`;
            try {
                const res = await fetch(`https://api.telegram.org/bot${telegramConfig.token}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: telegramConfig.chatID, text: message, parse_mode: 'HTML' })
                });
                if(res.ok) showMsg("‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");
                else throw new Error();
            } catch (e) { showMsg("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ"); }
            finally { setTimeout(() => { btn.disabled = false; btn.innerText = 'üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'; }, 5000); }
        }

        window.onload = async () => {
            await loadConfig();
            renderOrders();
            document.getElementById('current-time').innerText = new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
        };
    </script>
</body>
</html>